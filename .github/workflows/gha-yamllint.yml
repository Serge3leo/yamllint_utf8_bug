---
# vim:set sw=2 ts=8 et fileencoding=utf8:
# SPDX-License-Identifier: BSD-3-Clause
# Copyright Â© 2023, Serguei E. Leontiev (leo@sai.msu.ru)
#
name: Python yamllint test

on: push  # yamllint disable-line rule:truthy

jobs:
  lint:
    strategy:
      fail-fast: false  # TODO true
      matrix:
        os: ["macos", "ubuntu", "windows"]

    runs-on: ${{ matrix.os }}-latest
    defaults:
      run:
        shell: bash -el {0}

    steps:
      - uses: actions/checkout@v3

      - name: Install yamllint
        run: pip install yamllint

      - name: Lint .github YAML files
        run: yamllint .github

      - name: Test greek.yml
        run: |
          python -c "import locale; \
                     print(locale.getlocale(), \
                           locale.getpreferredencoding())"

          if [ "${{ matrix.os }}" == "windows" ] ; then
            if yamllint greek.yml ; then
              echo "XFAIL: ('English_United States', '1252') cp1252"
            else
              echo "XPASS: windows locales"
              exit 10
            fi
          else
            yamllint greek.yml
            if [ "${{ matrix.os }}" == "ubuntu" ] ; then
              sudo localedef -f CP1251 -i ru_RU ru_RU.CP1251
            fi
            echo "locale -a"
            locale -a
            echo "locale"
            locale
            echo "env"
            env
            export LANG=ru_RU.CP1251
            echo "locale 2"
            locale

            python -c "import locale; \
                       print(locale.getlocale(), \
                             locale.getpreferredencoding())"
            if yamllint greek.yml ; then
              echo "XFAIL: ru_RU.CP1251"
            else
              echo "XPASS: ru_RU.CP1251"
            fi
          fi
